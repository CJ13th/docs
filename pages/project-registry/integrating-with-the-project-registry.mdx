import { Tabs, Tab } from 'nextra/components'

# Integrating with the Project Registry
There are two ways to interact with the Project Registry. 
1. Through the `Registry.sol` contract
2. Through the Allo subgraph

## Writing to the Project Registry
The `Registry.sol` contract is available at the following locations:
* Goerli: 0xAEc621EC8D9dE4B524f4864791171045d6BBBe27

### Create a Profile
Creating a profile is required to create a pool. Some pools may also require 
recipients or allocators to have a profile. 
`createProfile` will return a `profileId`. This value will be needed for 
future calls to the registry.

```
createIdentity(nonce, name, metadata, signer.address, []);
```
  #### Parameters
| name | data type | notes |
| --- | --- | --- |
| _nonce | uint256 | nonce is used to create the profile profileId. By providing a nonce projects can ensure having the same id across chains. |
| _name | string | The profile name. This is used to generate the anchor. |
| _metadata | Metadata | See the metadata section below for more details.|
| _owner | address | The owner of the profile. See [Roles](/roles.md) for more details about profile owners. |
| _members | address[] | Array of profile member address. [Roles](/roles.md) for more details about profile members. |

#### Metadata

Offchain metadata can be stored in the project registry using the Metadata
struct.

```solidity
struct Metadata {
    uint256 protocol;
    string pointer;
}
```
| Field | Data Type | Notes |
| --- | --- | --- |
| protocol | uint256 | An id from the list of available protocols. | 
| pointer | string | The pointer to the off chain data. | 

Currently, the only protocol id available is '1' for IPFS. For more details on
details see
[`MetaPtrProtocol.sol`](https://github.com/allo-protocol/allo-contracts/blob/main/docs/MetaPtrProtocol.md)

### Updating a Profile


#### addMembers 
Adds member addresses to the members array.
Only the profile owner can add members.
`addMembers(profileId, members)`

| Field | Data Type | Notes |
| --- | --- | --- |
| profileId | bytes32 | The id of the profile to update. | 
| members | address[] | Array of member address(es) to add. | 

#### removeMembers
Removes member addresses to the members array.
Only the profile owner can remove members.
`removeMembers(profileId, members)`

| Field | Data Type | Notes |
| --- | --- | --- |
| profileId | bytes32 | The id of the profile to update. | 
| members | address[] | Array of member address(es) to remove. | 

#### updateProfileMetadata
Will overwrite the existing profile metadata. 
Only the owner can update profile metadata. 

`updateProfileMetadata(profileId, metadata)`
| Field | Data Type | Notes |
| --- | --- | --- |
| profileId | bytes32 | The id of the profile to update. | 
| metadata | Metadata | Metadata to add to the profile. | 

#### updateProfileName
Will set a new name for the profile. 
Only the owner can update profile metadata. 
This action will create a new anchorId.

`updateProfileName(profileId, name)`
| Field | Data Type | Notes |
| --- | --- | --- |
| profileId | bytes32 | The id of the profile to update. | 
| name | string | New name for the profile. | 

#### updateProfilePendingOwner
Will set a new pending owner. The pending owner will need to call 
`acceptProfileOwnership` in order for the ownership transfer to be complete.
Only the profile owner can set a pending owner. 

updateProfilePendingOwner(profileId, pendingOwner)
| Field | Data Type | Notes |
| --- | --- | --- |
| profileId | bytes32 | The id of the profile to update. | 
| pendingOwner | address | The address for the new profile owner. | 

## Allo V2 Subgraph
Project registry data is publicly available through The Graph.
The graph is available for the following chains:
* Goerli: https://thegraph.com/hosted-service/subgraph/allo-protocol/allo-v2-goerli

## Reading Project Registry Data Using The Graph

Subgraph data can be accessed either manually through the subgraph Playground,
or programmatically through The Graph API. For more information about how to set
up these methods, please see the [Querying the
Graph](https://thegraph.com/docs/en/querying/querying-the-graph/) page in The
Graph documentation.

If you would like to display Project Registry data in another app, see The Graph
article on [Querying from an
Application](https://thegraph.com/docs/en/querying/querying-from-an-application/).

## Query Examples
<Tabs items={['js', 'solidity']}>
  <Tab>
    ```
    //Allo subgraph query url
    const url = `https://api.thegraph.com/subgraphs/name/allo-protocol/allo-v2-goerli`
    //define the query
    const query = ` {
      roles(first: 5) {
        id
        accounts {
          id
        }
      }
    }
  `;
    //prepare the request body
    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ query: userArticle }),
    };

    //handle the response
    fetch(url, options)
    .then(response => response.json())
    .then(data => {
      console.log(data);
    })
    .catch(error => {
      console.error(error);
    });

    ```
  </Tab>

  <Tab>
    ```
        To Do
    ```
  </Tab>
</Tabs>


## Query Structure

Below is a JSON structure of available query fields for the Allo Project
Registry.

Queries can be built through The Graph playground.

```
metadata(
  block: Block_height
  first: Int = 100
  orderBy: Metadata_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Metadata_filter
): [Metadata!]!

role(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): Role

roles(
  block: Block_height
  first: Int = 100
  orderBy: Role_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Role_filter
): [Role!]!

account(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): Account

accounts(
  block: Block_height
  first: Int = 100
  orderBy: Account_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Account_filter
): [Account!]!

roleAccount(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): RoleAccount

roleAccounts(
  block: Block_height
  first: Int = 100
  orderBy: RoleAccount_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: RoleAccount_filter
): [RoleAccount!]!

profile(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): Profile

profiles(
  block: Block_height
  first: Int = 100
  orderBy: Profile_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Profile_filter
): [Profile!]!

allo(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): Allo

allos(
  block: Block_height
  first: Int = 100
  orderBy: Allo_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Allo_filter
): [Allo!]!

pool(
  block: Block_height
  id: ID!
  subgraphError: _SubgraphErrorPolicy_! = deny
): Pool

pools(
  block: Block_height
  first: Int = 100
  orderBy: Pool_orderBy
  orderDirection: OrderDirection
  skip: Int = 0
  subgraphError: _SubgraphErrorPolicy_! = deny
  where: Pool_filter
): [Pool!]!

_meta(block: Block_height): _Meta_
```


## Object Definition Tables
